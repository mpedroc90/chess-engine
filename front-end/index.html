<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Document</title>
  </head>
  <body>
    <canvas id="myCanvas" onclick="" style="border: solid 1px black"> </canvas>

    <div>
      <lable> FEN </lable><input id="text" type="text" />
      <button onclick="draw()">Draw</button>
    </div>
  </body>

  <script src="../game/"></script>
  <script>
    // rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR
    const DIMENSION = 8;
    const CELL_SIZE = 100;
    const canvas = document.getElementById("myCanvas");
    const ctx = canvas.getContext("2d");

    let selected = null;
    let pieces = new Map();

    canvas.onclick = function (e) {
      const cell = detectCell(e.offsetX, e.offsetY);
      if (selected === null) {
          selectPiece(cell);
          return;
      }

      if (cell[2] !== selected[2]) {
        movePiece(selected, cell);
        selected = null;
     
      }
      unselectPiece(cell)
    };

    canvas.onmousemove = function (e) {
      const cell = detectCell(e.offsetX, e.offsetY);
      if (pieces.has(cell[2])) {
        e.target.style.cursor = "all-scroll";
      } else {
        e.target.style.cursor = "default";
      }
    };

    function drawBoard(canvas) {
      canvas.width = DIMENSION * CELL_SIZE;
      canvas.height = DIMENSION * CELL_SIZE;
      for (let i = 0; i < DIMENSION; i++)
        for (let j = 0; j < DIMENSION; j++) {
          drawEmptyCell(i, j);
        }
    }

    function drawEmptyCell(r, c, color) {
      ctx.clearRect(r * CELL_SIZE, c * CELL_SIZE, CELL_SIZE, CELL_SIZE);
      ctx.fillStyle = !!color ? color : (r + c) % 2 == 0 ? "white" : "green";
      ctx.fillRect(r * CELL_SIZE, c * CELL_SIZE, CELL_SIZE, CELL_SIZE);
    }

    function drawPiece(x, y, src) {
      const img = new Image();
      img.onload = function () {
        ctx.drawImage(img, x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
      };
      img.src = src;

      const cell = detectCell(x * CELL_SIZE, y * CELL_SIZE);
      pieces.set(cell[2], src);
    }

    function drawPieces(canvas, fen) {
      let r = 0;
      let c = 0;
      for (let i = 0; i < fen.length; i++) {
        if (fen[i] >= "1" && fen[i] <= "9") {
          r += fen[i] - "0";
        } else if (fen[i] === "/") {
          c++;
          r = 0;
        } else {
          const pieceSrc =
            fen[i] >= "a" && fen[i] <= "z"
              ? `./assets/Chess_${fen[i]}dt45.svg`
              : `./assets/Chess_${fen[i]}lt45.svg`;
          drawPiece(r, c, pieceSrc);
          r++;
        }
      }
    }
    
    function detectCell(x, y) {
      return [
        Math.floor(x / CELL_SIZE),
        Math.floor(y / CELL_SIZE),
        `(${Math.floor(x / CELL_SIZE) + 1},${Math.floor(y / CELL_SIZE) + 1})`,
      ];
    }

    function selectPiece (cell) {
        selected = cell;
        if (pieces.has(selected[2])) {
          drawEmptyCell(selected[0], selected[1], "rgba(166, 245, 39, 0.49)");
          drawPiece(selected[0], selected[1], pieces.get(selected[2]));
        }
    }

    function unselectPiece() {
        if (pieces.has(selected[2])) {
          drawEmptyCell(selected[0], selected[1]);
          drawPiece(selected[0], selected[1], pieces.get(selected[2]));
        }
        selected = null;
    }

    function movePiece(origin, target) {
      if (pieces.has(origin[2])) {
        drawEmptyCell(origin[0], origin[1]);
        drawEmptyCell(target[0],target[1]);
        drawPiece(target[0], target[1], pieces.get(origin[2]));
      }
    }

    drawBoard(canvas);
    drawPieces(canvas, `rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR`);
  </script>
</html>
